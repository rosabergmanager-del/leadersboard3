<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>FTD</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;
      --bg2:#1a1f3a;
      --panel:#121933;
      --muted:#aab1c3;
      --text:#e8ecf8;
      --accent:#7dd3fc;
      --good:#34d399;
      --warn:#f59e0b;
      --bad:#ef4444;
      --gold:#fbbf24;
      --silver:#e5e7eb;
      --bronze:#d97706;
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    html,body{height:100%;overflow-x:hidden}
    
    body{
      font-family:"Inter",system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
      position:relative;
    }
    
    body::before{
      content:''; 
      position:fixed;
      top:0; 
      left:0; 
      right:0; 
      bottom:0; 
      background: radial-gradient(circle at 20% 80%, rgba(125,211,252,0.15) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(52,211,153,0.15) 0%, transparent 50%), radial-gradient(circle at 40% 40%, rgba(245,158,11,0.1) 0%, transparent 50%);
      pointer-events:none;
      z-index:1;
    }
    
    .container{
      max-width:1200px;
      margin:0 auto;
      padding:24px;
      position:relative;
      z-index:2;
    }
    
    header{
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:32px;
      position:relative;
    }
    
    .title{
      font-weight:900;
      font-size:clamp(24px, 5vw, 36px);
      letter-spacing:-0.5px;
      display:flex;
      align-items:center;
      gap:12px;
      text-align:center;
      background:linear-gradient(135deg, #fff 0%, var(--accent) 50%, #fff 100%);
      background-size:200% 200%;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:titleGradient 3s ease-in-out infinite;
      text-shadow:0 0 40px rgba(125,211,252,0.5);
    }
    
    @keyframes titleGradient{
      0%,100%{background-position:0% 50%}
      50%{background-position:100% 50%}
    }
    
    .title span{
      font-size:1.2em;
      animation:trophyRotate 3s ease-in-out infinite;
      display:inline-block;
      filter:drop-shadow(0 0 10px rgba(255,215,0,0.6));
    }
    
    @keyframes trophyRotate{
      0%,100%{transform:rotate(-5deg) scale(1)}
      50%{transform:rotate(5deg) scale(1.1)}
    }
    
    .stats-bar{
      display:flex;
      gap:16px;
      margin-bottom:24px;
      flex-wrap:wrap;
      justify-content:center;
    }
    
    .stat-card{
      background:linear-gradient(135deg, rgba(125,211,252,.08), rgba(52,211,153,.08));
      border:1px solid rgba(125,211,252,.25);
      backdrop-filter:blur(10px);
      border-radius:16px;
      padding:16px 24px;
      box-shadow:0 8px 32px rgba(0,0,0,.3);
      display:flex;
      align-items:center;
      gap:16px;
      flex:1;
      min-width:200px;
      position:relative;
      overflow:hidden;
    }
    
    .stat-icon{
      font-size:32px;
      animation:bounce 2s infinite;
    }
    
    @keyframes bounce{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-8px)}
    }
    
    .stat-content h3{
      font-size:14px;
      color:var(--muted);
      font-weight:600;
      margin-bottom:4px;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    
    .stat-value{
      font-size:28px;
      font-weight:800;
      color:var(--accent);
      text-shadow:0 0 20px rgba(125,211,252,.6);
      position:relative;
      display:inline-block;
    }
    
    .stat-value.increasing{
      animation:statIncrease 1s cubic-bezier(0.68,-0.55,0.265,1.55);
      color:var(--good);
    }
    
    .stat-value.major-increase{
      animation:statMajorIncrease 1.5s cubic-bezier(0.68,-0.55,0.265,1.55);
      color:#00ff88;
      text-shadow:0 0 30px rgba(0,255,136,.8), 0 0 60px rgba(0,255,136,.4);
    }
    
    @keyframes statIncrease{
      0%{transform:scale(1)}
      50%{transform:scale(1.2);color:#fff}
      100%{transform:scale(1)}
    }
    
    @keyframes statMajorIncrease{
      0%{transform:scale(1);filter:brightness(1)}
      25%{transform:scale(1.3);filter:brightness(1.5)}
      50%{transform:scale(1.1);filter:brightness(1.2)}
      100%{transform:scale(1);filter:brightness(1)}
    }
    
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));
      gap:24px;
    }
    
    .card{
      background:linear-gradient(145deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.1);
      backdrop-filter:blur(12px);
      border-radius:24px;
      padding:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.4);
      position:relative;
      overflow:hidden;
    }
    
    .card::before{
      content:''; 
      position:absolute; 
      top:0; 
      left:0; 
      right:0; 
      height:4px;
      background:linear-gradient(90deg, var(--accent), var(--good), var(--warn));
      animation:topBar 3s linear infinite;
      background-size:200% 100%;
    }
    
    @keyframes topBar{
      0%{background-position:0% 0%}
      100%{background-position:200% 0%}
    }
    
    .card h2{
      margin:8px 0 16px 0;
      font-size:24px;
      font-weight:800;
      color:#fff;
      letter-spacing:-0.5px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .team-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:32px;
      height:32px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--accent), var(--good));
      font-size:16px;
      font-weight:700;
      color:var(--bg);
      animation:badgePulse 2s ease-in-out infinite;
    }
    
    @keyframes badgePulse{
      0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(125,211,252,0.4)}
      50%{transform:scale(1.05);box-shadow:0 0 0 10px rgba(125,211,252,0)}
    }
    
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
      position:relative;
      overflow:hidden;
    }
    
    .row.team-leader{
      background:linear-gradient(135deg, rgba(255,215,0,.25), rgba(255,215,0,.1));
      border:2px solid var(--gold);
      box-shadow:0 0 30px rgba(255,215,0,.5), inset 0 0 20px rgba(255,215,0,.1);
      animation:leaderGlow 2.5s ease-in-out infinite;
      transform:translateZ(0);
    }
    
    .row.team-leader::before{
      content:''; 
      position:absolute; 
      top:0; 
      left:-100%; 
      width:100%; 
      height:100%; 
      background:linear-gradient(90deg, transparent, rgba(255,215,0,.4), transparent);
      animation:shimmer 2s infinite;
    }
    
    @keyframes shimmer{
      0%{left:-100%}
      100%{left:100%}
    }
    
    .row.team-leader .name{
      font-weight:800;
      font-size:15px;
      color:#fff;
      text-shadow:0 0 15px rgba(255,215,0,.8);
    }
    
    .row.team-leader .name::before{
      content:'üëë ';
      font-size:20px;
      animation:crownFloat 2s ease-in-out infinite;
      display:inline-block;
      filter:drop-shadow(0 0 10px rgba(255,215,0,.8));
    }
    
    @keyframes crownFloat{
      0%,100%{transform:translateY(0) rotate(-5deg)}
      50%{transform:translateY(-4px) rotate(5deg)}
    }
    
    .row.team-leader .ftd-value{
      font-weight:900;
      font-size:18px;
      color:#fff;
      text-shadow:0 0 20px rgba(255,215,0,.8);
    }
    
    @keyframes leaderGlow{
      0%,100%{box-shadow:0 0 30px rgba(255,215,0,.5), inset 0 0 20px rgba(255,215,0,.1)}
      50%{box-shadow:0 0 50px rgba(255,215,0,.8), inset 0 0 30px rgba(255,215,0,.2);transform:translateY(-2px)}
    }
    
    .row.second-place{
      background:linear-gradient(135deg, rgba(192,192,192,.2), rgba(192,192,192,.08));
      border:2px solid rgba(192,192,192,.5);
      box-shadow:0 0 25px rgba(192,192,192,.4);
    }
    
    .row.second-place .name{
      font-weight:700;
      color:#fff;
      text-shadow:0 0 12px rgba(192,192,192,.8);
    }
    
    .row.second-place .name::before{
      content:'ü•à ';
      font-size:18px;
      display:inline-block;
      animation:medalSwing 2.5s ease-in-out infinite;
      filter:drop-shadow(0 0 8px rgba(192,192,192,.6));
    }
    
    @keyframes medalSwing{
      0%,100%{transform:rotate(-10deg)}
      50%{transform:rotate(10deg)}
    }
    
    .row.third-place{
      background:linear-gradient(135deg, rgba(205,127,50,.18), rgba(205,127,50,.06));
      border:2px solid rgba(205,127,50,.45);
      box-shadow:0 0 20px rgba(205,127,50,.35);
    }
    
    .row.third-place .name{
      font-weight:700;
      color:#fff;
      text-shadow:0 0 10px rgba(217,119,6,.7);
    }
    
    .row.third-place .name::before{
      content:'ü•â ';
      font-size:17px;
      display:inline-block;
      animation:bronzeWobble 3s ease-in-out infinite;
      filter:drop-shadow(0 0 6px rgba(205,127,50,.5));
    }
    
    @keyframes bronzeWobble{
      0%,100%{transform:translateX(0) rotate(0)}
      25%{transform:translateX(-2px) rotate(-5deg)}
      75%{transform:translateX(2px) rotate(5deg)}
    }
    
    .row .name{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      font-size:14px;
      color:#e2e8f0;
      flex:1;
    }
    
    .position-badge{
      font-size:12px;
      font-weight:700;
      color:var(--text);
      background:rgba(125,211,252,.1);
      border:1px solid rgba(125,211,252,.3);
      padding:4px 8px;
      border-radius:8px;
      min-width:24px;
      text-align:center;
    }
    
    .progress-container{
      flex:1;
      max-width:120px;
      margin:0 12px;
    }
    
    .progress-bar{
      height:6px;
      background:rgba(255,255,255,.1);
      border-radius:3px;
      overflow:hidden;
      position:relative;
    }
    
    .progress-fill{
      height:100%;
      background:linear-gradient(90deg, var(--accent), var(--good));
      border-radius:3px;
      transition:width 0.8s cubic-bezier(0.4,0,0.2,1);
      position:relative;
      box-shadow:0 0 10px rgba(125,211,252,.5);
    }
    
    .progress-fill::after{
      content:''; 
      position:absolute; 
      top:0; 
      right:0; 
      bottom:0; 
      width:20px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.5));
      animation:progressShine 2s linear infinite;
    }
    
    @keyframes progressShine{
      0%{transform:translateX(-20px)}
      100%{transform:translateX(20px)}
    }
    
    .ftd-container{
      display:flex;
      align-items:center;
      gap:4px;
      position:relative;
      min-width:80px;
      justify-content:flex-end;
    }
    
    .ftd-value{
      font-weight:700;
      font-size:16px;
      color:var(--accent);
      text-shadow:0 0 10px rgba(125,211,252,.5);
      position:relative;
      display:inline-block;
      transition:all 0.3s ease;
    }
    
    .ftd-value.increasing{
      animation:ftdIncrease 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      color:var(--good);
    }
    
    .ftd-value.decreasing{
      animation:ftdDecrease 1s cubic-bezier(0.34, 1.56, 0.64, 1);
      color:var(--bad);
    }
    
    .ftd-value.major-increase{
      animation:ftdMajorIncrease 1.8s cubic-bezier(0.68,-0.55,0.265,1.55);
      color:#00ff88;
      text-shadow:0 0 25px rgba(0,255,136,.8), 0 0 50px rgba(0,255,136,.4);
    }
    
    .ftd-value.major-decrease{
      animation:ftdMajorDecrease 1.5s cubic-bezier(0.68,-0.55,0.265,1.55);
      color:#ff3333;
      text-shadow:0 0 25px rgba(255,51,51,.8), 0 0 50px rgba(255,51,51,.4);
    }
    
    @keyframes ftdIncrease{
      0%{transform:translateY(0) scale(1);filter:brightness(1) saturate(1);}
      30%{transform:translateY(-10px) scale(1.2);filter:brightness(1.4) saturate(1.3);}
      60%{transform:translateY(-5px) scale(1.1);filter:brightness(1.2) saturate(1.1);}
      100%{transform:translateY(0) scale(1);filter:brightness(1) saturate(1);}
    }
    
    @keyframes ftdDecrease{
      0%{transform:translateY(0) scale(1);filter:brightness(1);}
      30%{transform:translateY(8px) scale(0.9);filter:brightness(0.7);}
      60%{transform:translateY(4px) scale(0.95);filter:brightness(0.85);}
      100%{transform:translateY(0) scale(1);filter:brightness(1);}
    }
    
    @keyframes ftdMajorIncrease{
      0%{transform:translateY(-40px) scale(0.3) rotate(-360deg);opacity:0;filter:blur(8px) brightness(2) saturate(2);}
      25%{transform:translateY(-20px) scale(1.4) rotate(-180deg);opacity:0.8;filter:blur(4px) brightness(1.8) saturate(1.8);}
      50%{transform:translateY(0) scale(1.6) rotate(0deg);opacity:1;filter:blur(0) brightness(2.2) saturate(2);}
      75%{transform:translateY(-8px) scale(1.3) rotate(10deg);filter:brightness(1.6) saturate(1.5);}
      90%{transform:translateY(2px) scale(1.1) rotate(-5deg);filter:brightness(1.3) saturate(1.2);}
      100%{transform:translateY(0) scale(1) rotate(0deg);opacity:1;filter:blur(0) brightness(1) saturate(1);}
    }
    
    @keyframes ftdMajorDecrease{
      0%{transform:translateY(0) scale(1.5) rotate(0deg);opacity:1;filter:blur(0) brightness(1);}
      30%{transform:translateY(20px) scale(1.2) rotate(15deg);opacity:0.9;filter:blur(2px) brightness(0.7);}
      60%{transform:translateY(40px) scale(0.7) rotate(180deg);opacity:0.6;filter:blur(4px) brightness(0.5);}
      80%{transform:translateY(20px) scale(0.9) rotate(90deg);opacity:0.8;filter:brightness(0.8);}
      100%{transform:translateY(0) scale(1) rotate(0deg);opacity:1;filter:blur(0) brightness(1);}
    }
    
    .ftd-value.ripple-effect::after{
      content:''; 
      position:absolute; 
      top:50%; 
      left:50%; 
      width:0; 
      height:0;
      border-radius:50%;
      background:radial-gradient(circle, rgba(125,211,252,0.8) 0%, transparent 70%);
      transform:translate(-50%, -50%);
      animation:rippleExpand 1s ease-out;
      pointer-events:none;
      z-index:-1;
    }
    
    @keyframes rippleExpand{
      0%{width:0;height:0;opacity:1;}
      100%{width:120px;height:120px;opacity:0;}
    }
    
    .ftd-sparkle{
      position:absolute;width:6px;height:6px;background:linear-gradient(45deg, #fff, var(--accent));border-radius:50%;animation:sparkle 1s ease-out forwards;pointer-events:none;box-shadow:0 0 10px rgba(255,255,255,0.8);
    }
    
    @keyframes sparkle{
      0%{transform:translate(0, 0) scale(0) rotate(0deg);opacity:1;}
      50%{transform:translate(var(--tx), var(--ty)) scale(1.5) rotate(180deg);opacity:1;}
      100%{transform:translate(calc(var(--tx) * 1.5), calc(var(--ty) * 1.5)) scale(0.5) rotate(360deg);opacity:0;}
    }
    
    .ftd-change{
      font-size:12px;
      font-weight:600;
      padding:4px 8px;
      border-radius:8px;
      background:rgba(52,211,153,.25);
      color:var(--good);
      animation:changeSlide 1s cubic-bezier(0.68,-0.55,0.265,1.55);
      position:absolute;
      right:-70px;
      top:50%;
      transform:translateY(-50%);
      border:1px solid rgba(52,211,153,.4);
      box-shadow:0 4px 12px rgba(52,211,153,.3);
    }
    
    .ftd-change.negative{
      background:rgba(239,68,68,.25);
      color:var(--bad);
      border-color:rgba(239,68,68,.4);
      box-shadow:0 4px 12px rgba(239,68,68,.3);
    }
    
    @keyframes changeSlide{
      0%{opacity:0;transform:translateY(-50%) translateX(-20px) scale(0.5);}
      50%{transform:translateY(-50%) translateX(5px) scale(1.1);}
      100%{opacity:1;transform:translateY(-50%) translateX(0) scale(1);}
    }
    
    .total-ftd{
      position:absolute;
      right:16px;
      top:16px;
      font-size:14px;
      font-weight:700;
      color:var(--accent);
      background:rgba(125,211,252,.1);
      border:1px solid rgba(125,211,252,.3);
      padding:6px 12px;
      border-radius:12px;
      text-shadow:0 0 10px rgba(125,211,252,.5);
      animation:totalPulse 2s ease-in-out infinite;
    }
    
    @keyframes totalPulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.05)}
    }
    
    .bottom-toolbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      margin-top:32px;
      padding-top:24px;
      border-top:1px solid rgba(255,255,255,.1);
      flex-wrap:wrap;
    }
    
    button{
      cursor:pointer;
      background:linear-gradient(135deg, #1e293b, #334155);
      color:#e2e8f0;
      border:1px solid rgba(255,255,255,.15);
      border-radius:12px;
      padding:12px 20px;
      font-weight:600;
      font-size:14px;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    button::before{
      content:''; 
      position:absolute; 
      top:50%; 
      left:50%; 
      width:0; 
      height:0; 
      border-radius:50%;
      background:rgba(125,211,252,.3); 
      transform:translate(-50%,-50%);
      transition:width 0.6s, height 0.6s;
    }
    
    button:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(125,211,252,.3);
      border-color:var(--accent);
    }
    
    button:hover::before{
      width:300px;
      height:300px;
    }
    
    button:active{
      transform:translateY(0);
    }
    
    button span{
      position:relative;
      z-index:1;
    }
    
    .tooltip{
      position:absolute;
      background:rgba(0,0,0,.9);
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      font-size:12px;
      font-weight:500;
      white-space:nowrap;
      pointer-events:none;
      opacity:0;
      transform:translateY(10px);
      transition:all 0.3s;
      z-index:1000;
      box-shadow:0 4px 12px rgba(0,0,0,.3);
    }
    
    .tooltip.show{
      opacity:1;
      transform:translateY(0);
    }
    
    #overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.9);
      backdrop-filter:blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:clamp(48px, 10vw, 96px);
      font-weight:900;
      color:var(--accent);
      z-index:9999;
      text-align:center;
      text-transform:uppercase;
      opacity:0;
      pointer-events:none;
    }
    
    #overlay.show{
      animation:overlayShow 2.5s ease forwards;
    }
    
    @keyframes overlayShow{
      0%{opacity:0;transform:scale(0.5) rotateX(90deg)}
      40%{opacity:1;transform:scale(1.2) rotateX(0deg)}
      60%{transform:scale(0.95)}
      80%{opacity:1;transform:scale(1)}
      100%{opacity:0;transform:scale(1)}
    }
    
    #overlay span{
      background:linear-gradient(270deg,#7dd3fc,#34d399,#f59e0b,#ef4444,#a855f7,#7dd3fc);
      background-size:1200% 1200%;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:overlayGradient 2s linear infinite;
      filter:drop-shadow(0 0 40px currentColor);
    }
    
    @keyframes overlayGradient{
      0%{background-position:0% 50%}
      100%{background-position:100% 50%}
    }
    
    #confetti-canvas,#money-canvas{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:5000;
    }
    
    .particles{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index:1;
    }
    
    .particle{
      position:absolute;
      width:4px;
      height:4px;
      background:var(--accent);
      border-radius:50%;
      animation:float 20s linear infinite;
      opacity:0.3;
    }
    
    @keyframes float{
      from{transform:translateY(100vh) translateX(0) rotate(0deg);opacity:0}
      10%{opacity:0.3}
      90%{opacity:0.3}
      to{transform:translateY(-100vh) translateX(100px) rotate(360deg);opacity:0}
    }
    
    @media (max-width:768px){
      .container{padding:16px}
      .grid{grid-template-columns:1fr;gap:16px}
      .stat-card{min-width:100%;padding:12px 16px}
      .title{font-size:24px}
      .card{padding:16px}
      .progress-container{display:none}
      .bottom-toolbar{padding-top:16px;gap:8px}
      button{padding:10px 16px;font-size:13px}
    }
    
    @media (prefers-reduced-motion:reduce){
      *{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important}
    }
    
    .loading-spinner{
      display:inline-block;
      width:20px;
      height:20px;
      border:3px solid rgba(125,211,252,.2);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>
  <canvas id="money-canvas"></canvas>
  
  <div class="particles" id="particles"></div>
  
  <div class="container">
    <header>
      <div class="title">
        <span>üèÜ</span>
        <span style="-webkit-text-fill-color:revert"></span> <!-- –£–¥–∞–ª–µ–Ω–∞ –Ω–∞–¥–ø–∏—Å—å -->
        <span>üèÜ</span>
      </div>
    </header>

    <div class="stats-bar">
      <div class="stat-card" data-tooltip="–û–±—â–∞—è —Å—É–º–º–∞ FTD">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <h3>Total FTD</h3>
          <div class="stat-value" id="grand-total">0</div>
        </div>
      </div>
      <div class="stat-card" data-tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <h3>Teams</h3>
          <div class="stat-value" id="teams-count">0</div>
        </div>
      </div>
      <div class="stat-card" data-tooltip="–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç">
        <div class="stat-icon">üöÄ</div>
        <div class="stat-content">
          <h3>Top Score</h3>
          <div class="stat-value" id="top-score">0</div>
        </div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    
    <div class="bottom-toolbar">
      <button id="btn-audio" data-tooltip="–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã">
        <span>üîî –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</span>
      </button>
      <button id="btn-theme" data-tooltip="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
        <span>üé® –¢–µ–º–∞</span>
      </button>
      <button id="btn-fullscreen" data-tooltip="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º">
        <span>üñ•Ô∏è –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</span>
      </button>
    </div>
  </div>

  <div id="overlay"><span></span></div>
  <div class="tooltip" id="tooltip"></div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

<script>
(() => {
  const CONFIG = {
  SHEET_ID: "1mErOW57MrU_fhQnRsI1ZSldw7dpd7lrl4yu7EgMpx1o",
  API_KEY:  "AIzaSyCFS9Tse6vuK2O3PK4PyS0DDgRIzbC1F2E",
  RANGE:    "Sheet5!A:C",
  POLL_MS:  5000,
  MAX_CONCURRENT_EFFECTS: 2,
  PARTICLES_COUNT: 20,
  SOUNDS: {
    achievement: 'https://raw.githubusercontent.com/exellentyes-hue/sales-leaderboard/blob/main/videoplayback.mp3', // –≤–∞—à —Ñ–∞–π–ª
    levelUp: 'https://raw.githubusercontent.com/exellentyes-hue/sales-leaderboard/blob/main/videoplayback.mp3', // –≤–∞—à —Ñ–∞–π–ª
  },
  THEME: 'dark'
};


  const state = {
    soundEnabled: false,
    soundPool: [],
    prevByKey: new Map(),
    pollingTimer: null,
    currentFetch: null,
    backoffMs: CONFIG.POLL_MS,
    hidden: document.hidden,
    money: { image: null, animating: false, raf: 0, bills: [] },
    previousPositions: new Map(),
    theme: CONFIG.THEME
  };

  function initParticles(){
    const container = document.getElementById('particles');
    for(let i = 0; i < CONFIG.PARTICLES_COUNT; i++){
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 20 + 's';
      particle.style.animationDuration = (15 + Math.random() * 10) + 's';
      container.appendChild(particle);
    }
  }

  function normalizeKey(team, stage){
    return `${String(team||'').trim().toLowerCase()}|${String(stage||'').trim().toLowerCase()}`;
  }
  
  function toNum(x){
    if (typeof x === 'number') return x;
    const s = String(x ?? '').replace(/\s+/g,'').replace(',', '.');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  
  function groupByTeam(rows){
    const teams = {};
    rows.forEach(r => { 
      if(!teams[r.team]) teams[r.team] = [];
      teams[r.team].push(r);
    });
    return teams;
  }

  const SOUND_POOL_SIZE = 6;
  function initSoundPool(){
    state.soundPool = Array.from({length: SOUND_POOL_SIZE}, (_, i) => {
      const a = new Audio(i < 3 ? CONFIG.SOUNDS.achievement : CONFIG.SOUNDS.levelUp);
      a.preload = 'auto';
      a.playsInline = true;
      a.volume = 0.7;
      return a;
    });
  }
  
  function unlockAudioOnce(){
    Promise.allSettled(state.soundPool.map(a => a.play().then(() => { 
      a.pause();
      a.currentTime = 0;
    })))
    .finally(() => {
      state.soundEnabled = true;
      updateToolbar();
      showNotification('üîä –ó–≤—É–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
    });
  }
  
  function playSound(type = 'achievement'){
    if (!state.soundEnabled) return;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à –∑–≤—É–∫ –¥–ª—è –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤ (achievement –∏ levelUp)
    const soundUrl = CONFIG.SOUNDS[type];

    // –ù–∞–π–¥–µ–º –Ω–µ–∏–≥—Ä–∞—é—â–∏–π –∑–≤—É–∫ –≤ –ø—É–ª–µ
    const audio = state.soundPool.find(a => a.src === soundUrl && a.paused);
    
    if(audio){
      audio.currentTime = 0;
      audio.play().catch(err => console.warn('[Sound] play error:', err));
    } else {
      // –ï—Å–ª–∏ –∑–≤—É–∫–∏ –Ω–µ –±—ã–ª–∏ –ø—Ä–æ–∏–≥—Ä–∞–Ω—ã, –∑–∞–≥—Ä—É–∑–∏–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–º –Ω–æ–≤—ã–π
      const newSound = new Audio(soundUrl);
      newSound.volume = 0.7;
      newSound.play().catch(err => console.warn('[Sound] play error:', err));
    }
}


  function initToolbar(){
    const btnAudio = document.getElementById('btn-audio');
    if (btnAudio) {
      btnAudio.addEventListener('click', unlockAudioOnce);
    }
    
    const btnTheme = document.getElementById('btn-theme');
    if(btnTheme){
      btnTheme.addEventListener('click', toggleTheme);
    }
    
    const btnFullscreen = document.getElementById('btn-fullscreen');
    if(btnFullscreen){
      btnFullscreen.addEventListener('click', toggleFullscreen);
    }
    
    document.addEventListener('pointerdown', function once(){
      if(!state.soundEnabled) unlockAudioOnce();
      document.removeEventListener('pointerdown', once);
    }, { once:true });
    
    document.querySelectorAll('[data-tooltip]').forEach(el => {
      el.addEventListener('mouseenter', showTooltip);
      el.addEventListener('mouseleave', hideTooltip);
    });
  }
  
  function updateToolbar(){
    const btn = document.getElementById('btn-audio');
    if (btn) btn.innerHTML = state.soundEnabled ? '<span>üîä –ó–≤—É–∫ –∞–∫—Ç–∏–≤–µ–Ω</span>' : '<span>üîî –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</span>';
  }
  
  function toggleTheme(){
    state.theme = state.theme === 'dark' ? 'light' : 'dark';
    document.body.classList.toggle('light-theme');
    showNotification(state.theme === 'dark' ? 'üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞' : '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞');
  }
  
  function toggleFullscreen(){
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen();
      showNotification('üñ•Ô∏è –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º');
    } else {
      document.exitFullscreen();
    }
  }
  
  function showTooltip(e){
    const tooltip = document.getElementById('tooltip');
    const text = e.currentTarget.getAttribute('data-tooltip');
    tooltip.textContent = text;
    tooltip.classList.add('show');
    
    const rect = e.currentTarget.getBoundingClientRect();
    tooltip.style.left = rect.left + rect.width/2 - tooltip.offsetWidth/2 + 'px';
    tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';
  }
  
  function hideTooltip(){
    document.getElementById('tooltip').classList.remove('show');
  }
  
  function showNotification(text){
    const notification = document.createElement('div');
    notification.style.cssText = `
      position:fixed;
      top:20px;
      right:20px;
      background:linear-gradient(135deg, rgba(125,211,252,.9), rgba(52,211,153,.9));
      color:white;
      padding:12px 20px;
      border-radius:12px;
      font-weight:600;
      box-shadow:0 8px 24px rgba(0,0,0,.3);
      z-index:10000;
      animation:slideIn 0.3s ease-out;
    `;
    notification.textContent = text;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  function makeConfettiBurst(){
    const duration = 1500;
    const end = Date.now() + duration;
    const colors = ['#7dd3fc', '#34d399', '#f59e0b', '#ef4444', '#a855f7', '#ec4899'];
    
    (function frame(){
      confetti({
        particleCount: 6,
        angle: 60,
        spread: 70,
        origin: { x: 0, y: 0.6 },
        colors: colors,
        gravity: 0.8,
        scalar: 1.2,
        drift: 1
      });
      confetti({
        particleCount: 6,
        angle: 120,
        spread: 70,
        origin: { x: 1, y: 0.6 },
        colors: colors,
        gravity: 0.8,
        scalar: 1.2,
        drift: -1
      });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  function ensureMoneyImage(){
    return new Promise(resolve => {
      if (state.money.image){
        resolve(state.money.image);
        return;
      }
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = 'https://upload.wikimedia.org/wikipedia/commons/1/1a/USA_100_Dollar_Bill_Series2009_Obverse.png';
      img.onload = () => {
        state.money.image = img;
        resolve(img);
      };
      img.onerror = () => resolve(null);
    });
  }

  function makeMoneyRain(){
    if (state.money.animating) return;
    state.money.animating = true;
    
    ensureMoneyImage().then(img => {
      const canvas = document.getElementById('money-canvas');
      const ctx = canvas.getContext('2d');
      const W = canvas.width = window.innerWidth;
      const H = canvas.height = window.innerHeight;
      
      const bills = [];
      const count = 40;
      const fallDuration = 8000;
      const now = Date.now();
      
      for (let i = 0; i < count; i++){
        bills.push({
          x: Math.random() * W,
          y: -150,
          r: Math.random() * 360,
          rs: (Math.random() - 0.5) * 10,
          s: 80 + Math.random() * 60,
          t: now,
          d: Math.random() * 2000,
          w: Math.random() * 1000 - 500,
          opacity: 0.7 + Math.random() * 0.3
        });
      }
      
      state.money.bills = bills;
      
      function draw(){
        ctx.clearRect(0, 0, W, H);
        const time = Date.now();
        let alive = false;
        
        for (const b of bills){
          const elapsed = time - b.t - b.d;
          const prog = Math.min(Math.max(elapsed / fallDuration, 0), 1);
          
          if (prog < 1) alive = true;
          
          const y = b.y + prog * (H + 200);
          const x = b.x + Math.sin(prog * Math.PI * 3 + b.w) * 150;
          
          ctx.save();
          ctx.globalAlpha = b.opacity * (1 - Math.max(0, prog - 0.8) * 5);
          ctx.translate(x, y);
          ctx.rotate(b.r * Math.PI / 180);
          
          if (img) {
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 10;
            ctx.drawImage(img, -b.s/2, -b.s/4, b.s, b.s/2);
          }
          
          ctx.restore();
          b.r += b.rs;
        }
        
        if (alive){
          state.money.raf = requestAnimationFrame(draw);
        } else {
          state.money.animating = false;
          state.money.bills = [];
          ctx.clearRect(0, 0, W, H);
        }
      }
      
      draw();
    });
  }

  function showOverlay(name, ftd){
    const overlay = document.getElementById('overlay');
    const span = overlay.querySelector('span');
    span.textContent = `${name}: ${ftd} FTD! üöÄ`;
    overlay.classList.remove('show');
    void overlay.offsetWidth;
    overlay.classList.add('show');
    
    setTimeout(() => {
      overlay.classList.remove('show');
    }, 2500);
  }

  function createEnhancedSparkles(element){
    const rect = element.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    for(let i = 0; i < 12; i++){
      const sparkle = document.createElement('div');
      sparkle.className = 'ftd-sparkle';
      const angle = (Math.PI * 2 * i) / 12;
      const distance = 40 + Math.random() * 30;
      const offsetX = Math.cos(angle) * distance;
      const offsetY = Math.sin(angle) * distance;
      
      sparkle.style.setProperty('--tx', `${offsetX}px`);
      sparkle.style.setProperty('--ty', `${offsetY}px`);
      sparkle.style.left = centerX + 'px';
      sparkle.style.top = centerY + 'px';
      sparkle.style.animationDelay = `${i * 0.05}s`;
      
      document.body.appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 1000);
    }
  }
  
  function animateFTDValue(element, newValue, oldValue){
    if(oldValue === newValue) return;

    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    if(element.animationTimeout){
      clearTimeout(element.animationTimeout);
    }
    if(element.updateInterval){
      clearInterval(element.updateInterval);
    }

    const diff = newValue - oldValue;
    const percentChange = Math.abs((diff / (oldValue || 1)) * 100);

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã
    element.classList.remove('increasing', 'decreasing', 'major-increase', 'major-decrease', 'ripple-effect');
    void element.offsetWidth; // Force reflow

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
    if(percentChange > 20){
      if(diff > 0){
        element.classList.add('major-increase', 'ripple-effect');
        createEnhancedSparkles(element);
        playSound('levelUp'); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–º –≤–∞—à –∑–≤—É–∫ –¥–ª—è –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
      } else {
        element.classList.add('major-decrease');
      }
    } else if(diff > 0){
      element.classList.add('increasing');
      playSound('achievement'); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–º –≤–∞—à –∑–≤—É–∫ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
    } else {
      element.classList.add('decreasing');
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–∏—Å–ª–∞
    const duration = percentChange > 20 ? 1800 : 1200;
    const steps = 40;
    const stepDuration = duration / steps;
    let currentStep = 0;

    element.updateInterval = setInterval(() => {
      currentStep++;
      const progress = currentStep / steps;
      const easeProgress = easeOutCubic(progress);
      const currentValue = Math.round(oldValue + (diff * easeProgress));

      element.textContent = currentValue;

      if(currentStep >= steps){
        clearInterval(element.updateInterval);
        element.textContent = newValue;

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        element.animationTimeout = setTimeout(() => {
          element.classList.remove('increasing', 'decreasing', 'major-increase', 'major-decrease', 'ripple-effect');
        }, 800);
      }
    }, stepDuration);
}
  
  function easeOutCubic(t){
    return 1 - Math.pow(1 - t, 3);
  }

  function render(rows){
    const grid = document.getElementById('grid');
    const teams = groupByTeam(rows);
    const teamNames = Object.keys(teams).sort();
    
    let grandTotal = 0;
    let topScore = 0;
    
    const existingCards = new Map();
    grid.querySelectorAll('.card').forEach(card => {
      const teamName = card.querySelector('h2').textContent.replace(/[^\w\s]/g, '').trim();
      existingCards.set(teamName, card);
    });
    
    teamNames.forEach((team, teamIndex) => {
      let card = existingCards.get(team);
      
      if(!card){
        card = document.createElement('div');
        card.className = 'card';
        
        const h2 = document.createElement('h2');
        const badge = document.createElement('span');
        badge.className = 'team-badge';
        badge.textContent = team.charAt(0).toUpperCase();
        h2.appendChild(badge);
        h2.appendChild(document.createTextNode(' ' + team));
        card.appendChild(h2);
        
        const totalBadge = document.createElement('div');
        totalBadge.className = 'total-ftd';
        card.appendChild(totalBadge);
        
        const list = document.createElement('div');
        list.className = 'list';
        card.appendChild(list);
        
        grid.appendChild(card);
      }
      
      existingCards.delete(team);
      
      const total = teams[team].reduce((s, r) => s + (r.ftd || 0), 0);
      grandTotal += total;
      
      const totalBadge = card.querySelector('.total-ftd');
      const oldTotal = parseInt(totalBadge.textContent.replace(/\D/g, '')) || 0;
      if(oldTotal !== total){
        totalBadge.textContent = `FTD: ${total}`;
        if(oldTotal < total){
          totalBadge.style.animation = 'none';
          void totalBadge.offsetWidth;
          totalBadge.style.animation = 'totalPulse 0.6s ease-out';
        }
      }
      
      const list = card.querySelector('.list');
      const sortedTeamMembers = teams[team].sort((a, b) => (b.ftd || 0) - (a.ftd || 0));
      
      const existingRows = new Map();
      list.querySelectorAll('.row').forEach(row => {
        const name = row.querySelector('.name span:last-child').textContent;
        existingRows.set(name, row);
      });
      
      sortedTeamMembers.forEach((row, idx) => {
        topScore = Math.max(topScore, row.ftd || 0);
        
        let li = existingRows.get(row.stage);
        
        if(!li){
          li = document.createElement('div');
          li.className = 'row';
          
          const left = document.createElement('div');
          left.className = 'name';
          
          if(idx >= 3){
            const pos = document.createElement('span');
            pos.className = 'position-badge';
            pos.textContent = idx + 1;
            left.appendChild(pos);
          }
          
          const nm = document.createElement('span');
          nm.textContent = row.stage;
          left.appendChild(nm);
          
          const progressContainer = document.createElement('div');
          progressContainer.className = 'progress-container';
          const progressBar = document.createElement('div');
          progressBar.className = 'progress-bar';
          const progressFill = document.createElement('div');
          progressFill.className = 'progress-fill';
          progressBar.appendChild(progressFill);
          progressContainer.appendChild(progressBar);
          
          const ftdContainer = document.createElement('div');
          ftdContainer.className = 'ftd-container';
          const ftdValue = document.createElement('div');
          ftdValue.className = 'ftd-value';
          ftdValue.textContent = row.ftd;
          ftdContainer.appendChild(ftdValue);
          
          li.appendChild(left);
          li.appendChild(progressContainer);
          li.appendChild(ftdContainer);
          list.appendChild(li);
        }
        
        existingRows.delete(row.stage);
        
        li.className = 'row';
        if(idx === 0) li.classList.add('team-leader');
        else if(idx === 1) li.classList.add('second-place');
        else if(idx === 2) li.classList.add('third-place');
        
        const progressFill = li.querySelector('.progress-fill');
        const maxFtd = sortedTeamMembers[0].ftd || 1;
        const percentage = (row.ftd / maxFtd) * 100;
        progressFill.style.width = percentage + '%';
        
        const ftdValue = li.querySelector('.ftd-value');
        const oldFtd = parseInt(ftdValue.textContent) || 0;
        
        if(oldFtd !== row.ftd){
          animateFTDValue(ftdValue, row.ftd, oldFtd);
          
          const change = row.ftd - oldFtd;
          if(change !== 0){
            const changeEl = document.createElement('span');
            changeEl.className = change > 0 ? 'ftd-change' : 'ftd-change negative';
            changeEl.textContent = change > 0 ? `+${change}` : `${change}`;
            ftdValue.parentElement.style.position = 'relative';
            ftdValue.parentElement.appendChild(changeEl);
            setTimeout(() => changeEl.remove(), 4000);
          }
        }
        
        const positionBadge = li.querySelector('.position-badge');
        if(positionBadge){
          positionBadge.textContent = idx + 1;
        }
      });
      
      existingRows.forEach(row => row.remove());
    });
    
    existingCards.forEach(card => card.remove());
    
    animateFTDValue(document.getElementById('grand-total'), grandTotal, parseInt(document.getElementById('grand-total').textContent) || 0);
    animateFTDValue(document.getElementById('teams-count'), teamNames.length, parseInt(document.getElementById('teams-count').textContent) || 0);
    animateFTDValue(document.getElementById('top-score'), topScore, parseInt(document.getElementById('top-score').textContent) || 0);
  }

  function toObjects(values){
    const [header, ...rows] = values;
    
    const idx = {
      team: header.findIndex(h => /team/i.test(h)),
      stage: header.findIndex(h => /stage/i.test(h)),
      ftd: header.findIndex(h => /ftd/i.test(h))
    };
    
    const out = rows.map(r => ({
      team: r[idx.team] || '‚Äî',
      stage: r[idx.stage] || '‚Äî',
      ftd: toNum(r[idx.ftd])
    }));

    let effectsLaunched = 0;
    for (const o of out){
      const key = normalizeKey(o.team, o.stage);
      const prev = state.prevByKey.get(key);
      
      if (prev != null && o.ftd !== prev){
        const diff = o.ftd - prev;
        const percentChange = Math.abs((diff / (prev || 1)) * 100);
        
        if(diff > 0 && effectsLaunched < CONFIG.MAX_CONCURRENT_EFFECTS){
          o._up = true;
          effectsLaunched++;
          
          if(percentChange > 20){
            makeConfettiBurst();
            makeMoneyRain();
            playSound('levelUp');
            showOverlay(o.stage, o.ftd);
          } else {
            makeConfettiBurst();
            playSound('achievement');
          }
        } else if(diff < 0){
          o._down = true;
          if(percentChange > 20){
            showNotification(`‚ö†Ô∏è ${o.stage}: -${Math.abs(diff)} FTD`);
          }
        }
      } else {
        o._up = false;
        o._down = false;
      }
      
      state.prevByKey.set(key, o.ftd);
    }
    
    return out;
  }
  
  function sheetsUrl(){
    return `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(CONFIG.RANGE)}?key=${CONFIG.API_KEY}`;
  }
  
  async function fetchFromSheets(signal){
    const res = await fetch(sheetsUrl(), { signal, cache: 'no-store' });
    if (!res.ok) throw new Error(`Sheets error: ${res.status}`);
    const json = await res.json();
    return json.values;
  }

  async function load(){
    if (state.currentFetch) state.currentFetch.abort();
    const ctl = new AbortController();
    state.currentFetch = ctl;
    
    try{
      const values = await fetchFromSheets(ctl.signal);
      const rows = toObjects(values);
      render(rows);
      state.backoffMs = CONFIG.POLL_MS;
    } catch (e){
      console.warn('[Data] Error:', e);
      const sample = [
        ['Team', 'Stage', 'FTD'],
        ['Team Alpha', '–ò–≤–∞–Ω', 5],
        ['Team Alpha', '–ê–Ω–Ω–∞', 7],
        ['Team Beta', '–ü—ë—Ç—Ä', 4],
        ['Team Beta', '–û–ª—å–≥–∞', 8]
      ];
      const rows = toObjects(sample);
      render(rows);
      state.backoffMs = Math.min(Math.floor(state.backoffMs * 1.6), 60000);
    } finally {
      state.currentFetch = null;
      scheduleNextPoll();
    }
  }

  function scheduleNextPoll(){
    if (state.pollingTimer) clearTimeout(state.pollingTimer);
    if (document.hidden) return;
    state.pollingTimer = setTimeout(load, state.backoffMs);
  }

  function onResize(){
    const cc = document.getElementById('confetti-canvas');
    cc.width = innerWidth;
    cc.height = innerHeight;
    const mc = document.getElementById('money-canvas');
    mc.width = innerWidth;
    mc.height = innerHeight;
  }

  function onVisibility(){
    if (document.hidden){
      state.hidden = true;
      if (state.pollingTimer) clearTimeout(state.pollingTimer);
    } else {
      state.hidden = false;
      scheduleNextPoll();
    }
  }

  function init(){
    initParticles();
    initSoundPool();
    initToolbar();
    onResize();
    window.addEventListener('resize', onResize);
    document.addEventListener('visibilitychange', onVisibility);
    
    const style = document.createElement('style');
    style.textContent = `@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}`;
    document.head.appendChild(style);
    
    load();
  }

  init();
})();
</script>
</body>
</html>
