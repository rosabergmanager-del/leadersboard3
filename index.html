<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Leaderboard ‚Äî FTD</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;--panel:#121933;--muted:#aab1c3;--text:#e8ecf8;--accent:#7dd3fc;--good:#34d399;--warn:#f59e0b;--bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:radial-gradient(1200px 600px at 80% -10%, #1b2652 0%, rgba(27,38,82,0) 70%), var(--bg);color:var(--text);}

    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:18px}
    .title{font-weight:700;font-size:36px;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
    .pill{font-size:12px;background:rgba(125,211,252,.15);border:1px solid rgba(125,211,252,.35);padding:6px 10px;border-radius:999px;color:var(--accent)}

    .grid{display:flex;flex-wrap:wrap;justify-content:space-between;gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(6px);border-radius:18px;padding:32px 28px;box-shadow:0 10px 30px rgba(0,0,0,.25);position:relative;flex:1;min-width:320px}
    .card h2{margin:4px 0 10px 0;font-size:24px;font-weight:700;color:#e2e8f0}
    .list{display:flex;flex-direction:column}
    .row{display:flex;align-items:center;justify-content:space-between;padding:20px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);margin-bottom:8px}
    .row .name{display:flex;align-items:center;gap:10px;font-weight:600;font-size:16px}
    .badge{font-size:14px;color:#e8ecf8;background:#0f172a;border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px}
    .badge.first{color:gold}
    .row:first-child{background-color:gold;color:black}
    .row:nth-child(2){background-color:silver;color:black}
    .row:nth-child(3){background-color:#cd7f32;color:black}
    .ftd{font-weight:700;font-size:18px}
    .ftd.up{color:var(--good)}
    .total-ftd{font-size:16px;font-weight:700;color:var(--accent);position:absolute;right:10px;top:10px}
    .footer{opacity:.75;font-size:12px;margin-top:10px}
    .toolbar{display:flex;gap:8px;align-items:center}
    button{cursor:pointer;background:#1e293b;color:#e2e8f0;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px;font-weight:600}
    button:hover{background:#243046}
    .hint{font-size:12px;color:var(--muted)}

    /* ===== –û–≤–µ—Ä–ª–µ–π —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ ===== */
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;font-size:72px;font-weight:900;color:var(--accent);z-index:9999;text-align:center;text-transform:uppercase;opacity:0;pointer-events:none}
    #overlay.show{animation:zoomGlow 2s ease forwards}
    @keyframes zoomGlow{0%{transform:scale(.2);opacity:0;text-shadow:0 0 0px var(--accent)}40%{transform:scale(1.3);opacity:1;text-shadow:0 0 20px var(--accent),0 0 40px #0ff}70%{transform:scale(1);opacity:1;text-shadow:0 0 25px #fff,0 0 50px var(--accent)}100%{transform:scale(1);opacity:0;text-shadow:0 0 0px transparent}}
    #overlay span{background:linear-gradient(270deg,#7dd3fc,#34d399,#f59e0b,#ef4444,#7dd3fc);background-size:1000% 1000%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradientMove 3s linear infinite}
    @keyframes gradientMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    /* Canvas */
    #confetti-canvas,#money-canvas{position:fixed;inset:0;pointer-events:none}
    #money-canvas{z-index:5000}
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>
  <canvas id="money-canvas"></canvas>
  <div class="container">
    <header>
      <div class="title"><span>üèÜ</span> Sales Leaderboard <span>üèÜ</span></div>
    </header>

    <div id="grid" class="grid"></div>
  </div>

  <div id="overlay"><span></span></div>

  <!-- –û–¥–∏–Ω —Ä–∞–∑ –ø–æ–¥–∫–ª—é—á–∞–µ–º confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

<script>
(() => {
  // ======= CONFIG =======
  const CONFIG = {
    SHEET_ID: "1mErOW57MrU_fhQnRsI1ZSldw7dpd7lrl4yu7EgMpx1o",
    API_KEY:  "AIzaSyCFS9Tse6vuK2O3PK4PyS0DDgRIzbC1F2E",
    RANGE:    "Sheet4!A:C",
    POLL_MS:  5000,
    MAX_CONCURRENT_EFFECTS: 1, // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–º —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
  };

  // ======= STATE =======
  const state = {
    soundEnabled: false,
    soundPool: [],
    prevByKey: new Map(),
    pollingTimer: null,
    currentFetch: null,
    backoffMs: CONFIG.POLL_MS,
    hidden: document.hidden,
    money: { image: null, animating: false, raf: 0, bills: [] }
  };

  // ======= HELPERS =======
  function normalizeKey(team, stage){
    return `${String(team||'').trim().toLowerCase()}|${String(stage||'').trim().toLowerCase()}`;
  }
  function toNum(x){
    if (typeof x === 'number') return x;
    const s = String(x ?? '').replace(/\s+/g,'').replace(',', '.');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  function groupByTeam(rows){
    const teams = {};
    rows.forEach(r => { if(!teams[r.team]) teams[r.team] = []; teams[r.team].push(r); });
    return teams;
  }

  // ======= AUDIO (–ø—É–ª + –Ω–∞–¥—ë–∂–Ω–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞) =======
  const SOUND_SRC = 'https://raw.githubusercontent.com/exellentyes-hue/sales-leaderboard2/refs/heads/main/videoplayback.mp3';
  const SOUND_POOL_SIZE = 4;
  function initSoundPool(){
    state.soundPool = Array.from({length: SOUND_POOL_SIZE}, () => {
      const a = new Audio(SOUND_SRC);
      a.preload = 'auto'; a.playsInline = true; a.volume = 0.9; return a;
    });
  }
  function unlockAudioOnce(){
    Promise.allSettled(state.soundPool.map(a => a.play().then(() => { a.pause(); a.currentTime = 0; })))
      .finally(() => { state.soundEnabled = true; updateToolbar(); console.log('[FTD] Audio unlocked'); });
  }
  function playFTDSound(){
    if (!state.soundEnabled) return;
    const a = state.soundPool.find(x => x.paused) || state.soundPool[0].cloneNode(true);
    a.currentTime = 0; a.play().catch(err => console.warn('[FTD] play error:', err));
  }

  // ======= UI: toolbar =======
  function injectToolbar(){
    const header = document.querySelector('header'); if (!header) return;
    const bar = document.createElement('div'); bar.className = 'toolbar'; bar.style.marginLeft = '12px';
    const btn = document.createElement('button'); btn.id = 'btn-audio'; btn.textContent = 'üîî –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫'; btn.title = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –∑–≤—É–∫ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º'; btn.addEventListener('click', unlockAudioOnce);
    bar.appendChild(btn); header.appendChild(bar);
    document.addEventListener('pointerdown', function once(){ if(!state.soundEnabled) unlockAudioOnce(); document.removeEventListener('pointerdown', once); }, { once:true });
  }
  function updateToolbar(){
    const btn = document.getElementById('btn-audio'); if (btn) btn.textContent = state.soundEnabled ? 'üîä –ó–≤—É–∫ –∞–∫—Ç–∏–≤–µ–Ω' : 'üîî –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
  }

  // ======= EFFECTS =======
  function makeConfettiBurst(){
    const duration = 900; const end = Date.now() + duration;
    (function frame(){
      confetti({ particleCount: 4, angle: 60, spread: 65, origin: { x: 0 }, scalar: 1.1 });
      confetti({ particleCount: 4, angle: 120, spread: 65, origin: { x: 1 }, scalar: 1.1 });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  // –î–µ–Ω–µ–∂–Ω—ã–π –¥–æ–∂–¥—å ‚Äî –æ–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–µ—Å—Ç–∞—Ä—Ç—è—Ç
  function ensureMoneyImage(){
    return new Promise(resolve => {
      if (state.money.image){ resolve(state.money.image); return; }
      const img = new Image(); img.crossOrigin = 'anonymous';
      img.src = 'https://upload.wikimedia.org/wikipedia/commons/1/1a/USA_100_Dollar_Bill_Series2009_Obverse.png';
      img.onload = () => { state.money.image = img; resolve(img); };
      img.onerror = () => resolve(null);
    });
  }
  function makeMoneyRain(){
    if (state.money.animating) return; // –Ω–µ —Å–ø–∞–º–∏–º
    state.money.animating = true;
    ensureMoneyImage().then(img => {
      const canvas = document.getElementById('money-canvas'); const ctx = canvas.getContext('2d');
      const W = canvas.width = window.innerWidth; const H = canvas.height = window.innerHeight;
      const bills = []; const count = 30; const fallDuration = 7000; const now = Date.now();
      for (let i=0;i<count;i++) bills.push({ x: Math.random()*W, y:-100, r:Math.random()*360, rs:(Math.random()-.5)*8, s:100+Math.random()*50, t: now, d: Math.random()*1500, w: Math.random()*1000-500 });
      state.money.bills = bills;
      function draw(){
        ctx.clearRect(0,0,W,H);
        const time = Date.now(); let alive = false;
        for (const b of bills){
          const elapsed = time - b.t - b.d; const prog = Math.min(Math.max(elapsed / fallDuration, 0), 1);
          if (prog < 1) alive = true; const y = b.y + prog*(H+120); const x = b.x + Math.sin(prog*Math.PI*2 + b.w)*140;
          ctx.save(); ctx.translate(x,y); ctx.rotate(b.r*Math.PI/180); if (img) ctx.drawImage(img, -b.s/2, -b.s/4, b.s, b.s/2); ctx.restore(); b.r += b.rs;
        }
        if (alive) state.money.raf = requestAnimationFrame(draw); else { state.money.animating = false; }
      }
      draw();
    });
  }

  function showOverlay(name, ftd){
    const overlay = document.getElementById('overlay'); const span = overlay.querySelector('span');
    span.textContent = `${name}: ${ftd} üöÄ`;
    overlay.classList.remove('show'); void overlay.offsetWidth; overlay.classList.add('show');
    // –∫–ª–∞—Å—Å —Å–∞–º —É–±–µ—Ä—ë—Ç—Å—è –ø–æ animation end
  }

  // ======= RENDER =======
  function render(rows){
    const grid = document.getElementById('grid');
    grid.replaceChildren(); // –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º innerHTML=''
    const teams = groupByTeam(rows);
    const teamNames = Object.keys(teams).sort();

    for (const team of teamNames){
      const card = document.createElement('div'); card.className = 'card';
      const h2 = document.createElement('h2'); h2.textContent = team; card.appendChild(h2);

      const total = teams[team].reduce((s,r)=>s + (r.ftd||0), 0);
      const badge = document.createElement('div'); badge.className = 'total-ftd'; badge.textContent = `FTD: ${total}`; card.appendChild(badge);

      const list = document.createElement('div'); list.className = 'list';
      let rank = 1;
      teams[team].sort((a,b)=>(b.ftd||0)-(a.ftd||0)).forEach((row, idx) => {
        const li = document.createElement('div'); li.className = 'row';
        const left = document.createElement('div'); left.className = 'name';
        const pos = document.createElement('span'); pos.className = 'badge'; if (idx===0) pos.classList.add('first'); pos.textContent = rank++;
        const nm = document.createElement('span'); nm.textContent = row.stage;
        left.appendChild(pos); left.appendChild(nm);
        const right = document.createElement('div'); right.className = 'ftd' + (row._up ? ' up' : ''); right.textContent = row.ftd;
        li.appendChild(left); li.appendChild(right); list.appendChild(li);
      });
      card.appendChild(list); grid.appendChild(card);
    }
  }

  // ======= DATA TRANSFORM =======
  function toObjects(values){
    const [header, ...rows] = values;
    const idx = {
      team: header.findIndex(h => /team/i.test(h)),
      stage: header.findIndex(h => /stage/i.test(h)),
      ftd: header.findIndex(h => /ftd/i.test(h))
    };
    const out = rows.map(r => ({ team: r[idx.team] || '‚Äî', stage: r[idx.stage] || '‚Äî', ftd: toNum(r[idx.ftd]) }));

    let effectsLaunched = 0;
    for (const o of out){
      const key = normalizeKey(o.team, o.stage);
      const prev = state.prevByKey.get(key);
      if (prev != null && o.ftd > prev && effectsLaunched < CONFIG.MAX_CONCURRENT_EFFECTS){
        o._up = true; effectsLaunched++;
        makeConfettiBurst(); makeMoneyRain(); playFTDSound(); showOverlay(o.stage, o.ftd);
      } else { o._up = false; }
      state.prevByKey.set(key, o.ftd);
    }
    return out;
  }

  // ======= FETCH with Abort + —ç–∫—Å–ø. –±—ç–∫–æ—Ñ—Ñ + –ø–∞—É–∑–∞ –≤ —Ñ–æ–Ω–µ =======
  function sheetsUrl(){
    return `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(CONFIG.RANGE)}?key=${CONFIG.API_KEY}`;
  }
  async function fetchFromSheets(signal){
    const res = await fetch(sheetsUrl(), { signal, cache:'no-store' });
    if (!res.ok) throw new Error(`Sheets error: ${res.status}`);
    const json = await res.json();
    return json.values;
  }

  async function load(){
    // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –µ—â—ë –∏–¥—ë—Ç
    if (state.currentFetch) state.currentFetch.abort();
    const ctl = new AbortController(); state.currentFetch = ctl;
    try{
      const values = await fetchFromSheets(ctl.signal);
      const rows = toObjects(values);
      render(rows);
      // —É—Å–ø–µ—Ö ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –±—ç–∫–æ—Ñ—Ñ
      state.backoffMs = CONFIG.POLL_MS;
    } catch (e){
      console.warn('[FTD] Sheets error, using sample:', e);
      const sample = [ ['Team','Stage','FTD'], ['Team Alpha','–ò–≤–∞–Ω',5], ['Team Alpha','–ê–Ω–Ω–∞',7], ['Team Beta','–ü—ë—Ç—Ä',4], ['Team Beta','–û–ª—å–≥–∞',8] ];
      const rows = toObjects(sample); render(rows);
      // —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (–¥–æ 60—Å)
      state.backoffMs = Math.min(Math.floor(state.backoffMs * 1.6), 60000);
    } finally {
      state.currentFetch = null;
      scheduleNextPoll();
    }
  }

  function scheduleNextPoll(){
    if (state.pollingTimer) clearTimeout(state.pollingTimer);
    if (document.hidden) return; // –Ω–µ –æ–ø—Ä–∞—à–∏–≤–∞–µ–º, –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ —Ñ–æ–Ω–æ–º
    state.pollingTimer = setTimeout(load, state.backoffMs);
  }

  // ======= LIFECYCLE =======
  function onResize(){
    // –ø–æ–¥–¥–µ—Ä–∂–∏–º –∫–∞–Ω–≤–∞—Å—ã —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
    const cc = document.getElementById('confetti-canvas'); cc.width = innerWidth; cc.height = innerHeight;
    const mc = document.getElementById('money-canvas'); mc.width = innerWidth; mc.height = innerHeight;
  }

  function onVisibility(){
    if (document.hidden){ state.hidden = true; if (state.pollingTimer) clearTimeout(state.pollingTimer); }
    else { state.hidden = false; scheduleNextPoll(); }
  }

  // ======= INIT =======
  function init(){
    initSoundPool(); injectToolbar(); onResize(); window.addEventListener('resize', onResize);
    document.addEventListener('visibilitychange', onVisibility);
    load();
  }

  // —Å—Ç–∞—Ä—Ç
  init();
})();
</script>
</body>
</html>
